{"version":3,"sources":["component/VisualTools/Chart/BarChart.js"],"names":["PureComponent","BarChart","props","self","React","createRef","state","margin","top","right","bottom","left","loading","error","fields","x","y","data","transform","horizontal","field","new_data","d3","nest","key","d","sortKeys","ascending","rollup","v","length","entries","f","width","xScale","scaleBand","domain","map","range","padding","height","yScale","scaleLinear","max","selection","className","update_bars","selectAll","enter_bars","enter","append","attr","bind","bandwidth","innerHeight","on","i","selected","value","filter","id","title","operation","values","filterAdded","text","merge","transition","duration","exit","remove","filters","filterData","filterbars","drawBar","viewer","setTimeout","rect","current","getBoundingClientRect","innerWidth","svg","select","createXScale","createYScale","xAxis","axisBottom","call","wrap","yAxis","axisLeft","tickSize","bars","componentDidUpdate","each","word","words","split","reverse","line","lineNumber","dy","parseFloat","tspan","pop","push","join","node","getComputedTextLength","errorInfo","console","hasError"],"mappings":"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","file":"BarChart.03397b60.js","sourceRoot":"../source","sourcesContent":["import React, { PureComponent } from 'react'\nimport {isEquivalent} from '../../../common/utils.js'\nimport * as d3 from \"d3\";\n\nexport default class BarChart extends PureComponent {\n    constructor(props) {\n        super(props);\n        this.self = React.createRef();\n        this.state = {\n            margin: {top: 10, right: 10, bottom: 35, left: 35},\n            loading:true,\n            error:null,\n            fields:{x:'key',y:'value'}\n        }\n        this.state.data = this.transform(this.props.data, this.props.fields.x);\n        this.state.horizontal = true;\n    }\n    transform(data,field){\n        const new_data =  d3.nest()\n            .key(function(d) { return d[field]; })\n            .sortKeys(d3.ascending)\n            .rollup(function(v) { return v.length; })\n            .entries(data);\n        return new_data;\n\n    }\n\n    createXScale(f,width) {\n        // set the ranges\n        const xScale = d3.scaleBand()\n            .domain(this.state.data.map(function(d) { return d[f]; }))\n            .range([0, width])\n            .padding(0.1);\n\n        // xScale.invert = function(x) {\n        //     var domain = this.domain();\n        //     var range = this.range()\n        //     var scale = d3.scaleQuantize().domain(range).range(domain)\n        //     return scale(x)\n        // }\n        return xScale;\n    }\n\n    createYScale(f, height) {\n        const yScale = d3.scaleLinear()\n        .domain([0, d3.max(this.state.data, function(d) { return d[f]; })])\n        .range([height, 0]);\n        return yScale;\n    }\n\n    drawBar(selection, data, className='og') {\n        const update_bars = selection.selectAll(`rect.${className}`).data(data,d=> d[this.state.fields.x])\n\n        const enter_bars = update_bars.enter().append('rect')\n        enter_bars.attr('class', `${className}`)\n            .attr(\"x\", function(d) { return this.xScale(d[this.state.fields.x])}.bind(this))\n            .attr(\"width\", this.xScale.bandwidth())\n            .attr(\"y\",this.innerHeight)\n            //console.log(enter_bars)\n            enter_bars.on('click', (data,i) =>{\n                //enter_bars.attr('opacity',0.2)\n                const selected = enter_bars.filter(function(d){\n                  return d === data\n                })\n                //selected.attr('opacity',1)\n                const value = selected.data()[0].key\n                const filter = {\n                    id:this.props.id,\n                    title:this.props.title,\n                    field:this.props.fields.x,\n                    operation:'eq',\n                    values:value\n                }\n                this.props.filterAdded([filter])\n            })\n\n        enter_bars.append('title').text(d=> `${d.key}:${d.value}`)\n\n        update_bars.merge(enter_bars)\n            .transition().duration(1000)\n            .attr(\"y\", function(d) { return this.yScale(d[this.state.fields.y])}.bind(this))\n            .attr(\"height\", function(d) { return this.innerHeight - this.yScale(d[this.state.fields.y]); }.bind(this))\n\n        // update_bars\n\n        update_bars.exit()\n            .transition().duration(1000)\n            .attr('y',this.innerHeight)\n            .attr('height',0).remove()\n\n        return update_bars;\n\n    }\n\n    componentDidUpdate() {\n        // console.log('bar update',this.props)\n        let data = [];\n        if(this.props.filters.length > 0){\n            data = this.transform(this.props.filterData, this.props.fields.x)\n        }else{\n            data = this.transform(this.props.data, this.props.fields.x)\n        }\n        this.filterbars= this.drawBar(this.viewer,data,'ft');\n    }\n    componentDidMount() {\n        setTimeout(()=>{\n            const rect = this.self.current.getBoundingClientRect();\n            this.innerWidth = rect.width - this.state.margin.left - this.state.margin.right;\n            this.innerHeight = rect.height - this.state.margin.top - this.state.margin.bottom;\n            // create svg\n            const svg = d3.select(this.self.current)\n            .append(\"svg\")\n                .attr(\"width\", rect.width)\n                .attr(\"height\", rect.height)\n            // create viewer\n            this.viewer = svg.append(\"g\")\n                .attr(\"transform\", \"translate(\" + this.state.margin.left + \",\" + this.state.margin.top + \")\");\n            //\n            this.xScale = this.createXScale(this.state.fields.x, this.innerWidth);\n            this.yScale = this.createYScale(this.state.fields.y, this.innerHeight);\n\n            this.xAxis = d3.axisBottom(this.xScale)\n            //.tickSize(this.innerWidth)\n            this.viewer.append(\"g\")\n            .attr(\"class\", \"x axis\")\n            .attr(\"transform\", `translate(0,${this.innerHeight})`)\n            .call(this.xAxis)\n            .selectAll(\".tick text\")\n            .call(this.wrap, this.xScale.bandwidth());\n\n            // add the y Axis\n            this.yAxis = d3.axisLeft(this.yScale)\n            .tickSize(-this.innerWidth)\n            this.viewer.append(\"g\")\n                .call(this.yAxis);\n\n            this.bars = this.drawBar(this.viewer, this.state.data,'og')\n            this.filterbars = this.drawBar(this.viewer, this.state.data,'ft')\n\n            this.componentDidUpdate()\n\n        }, 500)\n\n    }\n    wrap(text, width) {\n        text.each(function() {\n          var text = d3.select(this),\n              words = text.text().split(/\\s+/).reverse(),\n              word,\n              line = [],\n              lineNumber = 0,\n              lineHeight = 1.1, // ems\n              y = text.attr(\"y\"),\n              dy = parseFloat(text.attr(\"dy\")),\n              tspan = text.text(null).append(\"tspan\").attr(\"x\", 0).attr(\"y\", y).attr(\"dy\", dy + \"em\");\n          while (word = words.pop()) {\n            line.push(word);\n            tspan.text(line.join(\" \"));\n            if (tspan.node().getComputedTextLength() > width) {\n              line.pop();\n              tspan.text(line.join(\" \"));\n              line = [word];\n              tspan = text.append(\"tspan\").attr(\"x\", 0).attr(\"y\", y).attr(\"dy\", ++lineNumber * lineHeight + dy + \"em\").text(word);\n            }\n          }\n        });\n    }\n\n    componentDidCatch(error, errorInfo) {\n      console.error(error, errorInfo);\n    }\n\n    static getDerivedStateFromError(error) {\n      return {hasError: true, error: error};\n    }\n\n    render() {\n      if (this.state.hasError){\n        return (<div>ERROR</div>);\n      } else {\n        return (\n            <div\n              id={this.props.id}\n              ref={this.self}\n              style={{ width: \"100%\", height: \"100%\" }}\n            ></div>\n        );\n      }\n    }\n}\n"]}